name: Android Play Store Release

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (X.Y.Z)'
        required: true
        default: '1.0.0'
      track:
        description: 'Play track to deploy to'
        required: true
        type: choice
        default: internal
        options:
          - internal
          - beta
          - production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PACKAGE_NAME: com.bttakeover.app
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Resolve version
        id: ver
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            VERSION_NAME="${{ github.event.inputs.version }}"
          else
            VERSION_NAME="${GITHUB_REF_NAME}"
          fi
          if [[ ! "$VERSION_NAME" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version must be semver X.Y.Z (no leading v). Got: $VERSION_NAME" >&2
            exit 1
          fi
          IFS='.' read -r MAJOR MINOR PATCH <<< "${VERSION_NAME}"
          MAJOR=${MAJOR:-0}; MINOR=${MINOR:-0}; PATCH=${PATCH:-0}
          VERSION_CODE=$((MAJOR*10000 + MINOR*100 + PATCH))
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "Resolved VERSION_NAME=${VERSION_NAME}, VERSION_CODE=${VERSION_CODE}"

      - name: Resolve track
        id: track
        shell: bash
        run: |
          TRACK_INPUT="${{ github.event.inputs.track }}"
          if [[ -z "$TRACK_INPUT" ]]; then TRACK_INPUT=internal; fi
          echo "TRACK=$TRACK_INPUT" >> $GITHUB_OUTPUT
          echo "Using Play track: $TRACK_INPUT"

      - name: Install Gradle (no wrapper)
        shell: bash
        run: |
          GRADLE_VERSION=8.7
          curl -sL https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip -o gradle.zip
          unzip -q gradle.zip -d $HOME/gradle
          echo "$HOME/gradle/gradle-${GRADLE_VERSION}/bin" >> $GITHUB_PATH

      - name: Build Android App Bundle (release)
        working-directory: android
        env:
          APP_VERSION_NAME: ${{ steps.ver.outputs.VERSION_NAME }}
          APP_VERSION_CODE: ${{ steps.ver.outputs.VERSION_CODE }}
        run: |
          gradle :app:bundleRelease --no-daemon --stacktrace

      - name: Prepare signing materials
        id: keystore
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [[ -z "$ANDROID_KEYSTORE_BASE64" ]]; then
            echo "Keystore not provided; failing." >&2
            exit 1
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/keystore.jks
          echo "FILE=android/keystore.jks" >> $GITHUB_OUTPUT

      - name: Sign AAB (jarsigner)
        env:
          KEYSTORE_PATH: ${{ steps.keystore.outputs.FILE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          AAB="android/app/build/outputs/bundle/release/app-release.aab"
          if [[ ! -f "$AAB" ]]; then echo "Missing AAB: $AAB" >&2; exit 1; fi
          jarsigner -keystore "$KEYSTORE_PATH" -storepass "$ANDROID_KEYSTORE_PASSWORD" -keypass "$ANDROID_KEY_PASSWORD" "$AAB" "$ANDROID_KEY_ALIAS"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android/app/build/outputs/bundle/release/app-release.aab
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare service account JSON
        id: svc
        shell: bash
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          if [[ -z "$PLAY_SERVICE_ACCOUNT_JSON" ]]; then
            echo "Google Play service account JSON not provided; failing." >&2
            exit 1
          fi
          printf "%s" "$PLAY_SERVICE_ACCOUNT_JSON" > service_account.json
          echo "FILE=service_account.json" >> $GITHUB_OUTPUT

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ steps.svc.outputs.FILE }}
          packageName: ${{ env.PACKAGE_NAME }}
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: ${{ steps.track.outputs.TRACK }}
          status: completed
          inAppUpdatePriority: 3
